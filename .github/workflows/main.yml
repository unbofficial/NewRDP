name: RDP-Ngrok-Final-Ultimate

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1. Setup Windows RDP & User
        run: |
          # RDP enable karna aur security settings fix karna
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          
          # Firewall mein RDP (3389) allow karna
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          
          # Naya User 'RDPUser' aur Password setup
          $password = "MySafePass123!"
          $securePass = ConvertTo-SecureString $password -AsPlainText -Force
          New-LocalUser -Name "RDPUser" -Password $securePass -AccountNeverExpires -ErrorAction SilentlyContinue
          
          # User ko Admin aur RDP Group mein add karna
          Add-LocalGroupMember -Group "Administrators" -Member "RDPUser" -ErrorAction SilentlyContinue
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser" -ErrorAction SilentlyContinue
          
          # Remote Desktop service ko restart karna taaki settings apply ho jayein
          Restart-Service -Name "TermService" -Force

      - name: 2. Install and Start Ngrok
        shell: pwsh
        run: |
          choco install ngrok -y
          
          if ("${{ secrets.NGROK_AUTH_TOKEN }}" -eq "") {
            Write-Error "‚ùå ERROR: NGROK_AUTH_TOKEN is missing in GitHub Secrets!"
            exit 1
          }

          ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          
          Write-Host "Starting Ngrok Tunnel on Port 3389..."
          # 127.0.0.1 use karne se connection loopback stable rehta hai
          Start-Process ngrok -ArgumentList "tcp 127.0.0.1:3389 --region us"
          
          # Ngrok ko start hone ke liye thoda waqt dena
          Start-Sleep -Seconds 20

      - name: 3. Get RDP Address
        shell: pwsh
        run: |
          # Ngrok API se live address nikalna
          $response = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
          $address = $response.tunnels.public_url.Replace("tcp://", "")
          
          Write-Host "=========================================="
          Write-Host "üöÄ RDP IS READY! CONNECT NOW:"
          Write-Host "ADDRESS  : $address"
          Write-Host "USERNAME : .\RDPUser"
          Write-Host "PASSWORD : MySafePass123!"
          Write-Host "=========================================="

      - name: 4. Keep Alive (6 Hours)
        run: |
          $i = 0
          while($i -lt 360) {
            Write-Host "Runner is active... $(Get-Date)"
            Start-Sleep -Seconds 60
            $i++
          }
