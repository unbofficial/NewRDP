name: RDP-Final-Fix

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1. Setup Windows User
        shell: pwsh
        run: |
          # RDP Enable karna
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

          # User Details from Secrets
          $user = "${{ secrets.RDP_USERNAME }}"
          $pass = "${{ secrets.USER_PASSWORD }}"
          $secstr = ConvertTo-SecureString $pass -AsPlainText -Force

          # Pehle check karna agar user pehle se hai toh delete kar dena (Fresh Start)
          if (Get-LocalUser -Name $user -ErrorAction SilentlyContinue) {
              Remove-LocalUser -Name $user
          }

          # Naya User Create karna
          try {
              New-LocalUser -Name $user -Password $secstr -FullName "Cloud Admin Service" -Description "Standard Service Account" -AccountNeverExpires -ErrorAction Stop
              Add-LocalGroupMember -Group "Administrators" -Member $user
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $user
              Write-Host "‚úÖ SUCCESS: User $user created!"
          } catch {
              Write-Error "‚ùå FAILED: $_"
              exit 1
          }

          Restart-Service -Name "TermService" -Force

      - name: 2. Start Ngrok
        shell: pwsh
        run: |
          choco install ngrok -y
          ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          Start-Process ngrok -ArgumentList "tcp 127.0.0.1:3389 --region us"
          Start-Sleep -Seconds 20

      - name: 3. Connection Details
        shell: pwsh
        run: |
          $response = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
          $address = $response.tunnels.public_url.Replace("tcp://", "")
          Write-Host "=========================================="
          Write-Host "üöÄ RDP DETAILS (Copy Exactly):"
          Write-Host "ADDRESS  : $address"
          Write-Host "USERNAME : .\${{ secrets.RDP_USERNAME }}"
          Write-Host "PASSWORD : ${{ secrets.USER_PASSWORD }}"
          Write-Host "=========================================="

      - name: 4. Keep Alive
        shell: pwsh
        run: |
          while($true) { Write-Host "Active... $(Get-Date)"; Start-Sleep -Seconds 60 }
