name: RDP-Ngrok-Final-Ultimate

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: 1. Setup Windows RDP & User
        shell: pwsh
        run: |
          # 1. RDP Enable aur Security disable karna (taaki connection block na ho)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
          
          # 2. Secrets se data lena
          $name = "${{ secrets.RDP_USERNAME }}"
          $pass = "${{ secrets.USER_PASSWORD }}"
          
          # 3. User Create karna aur Password Forcefully set karna
          net user $name $pass /add /y
          net localgroup Administrators $name /add
          net localgroup "Remote Desktop Users" $name /add
          
          # Password kabhi expire na ho
          wmic useraccount where name="$name" set passwordexpires=false
          
          Write-Host "âœ… User [$name] successfully created with your secret password."
          
          # 4. RDP Service Restart
          Restart-Service -Name "TermService" -Force

      - name: 2. Start Ngrok
        shell: pwsh
        run: |
          choco install ngrok -y
          ngrok config add-authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          
          Write-Host "Starting Ngrok Tunnel..."
          Start-Process ngrok -ArgumentList "tcp 127.0.0.1:3389 --region us"
          Start-Sleep -Seconds 30

      - name: 3. Connection Details
        shell: pwsh
        run: |
          $response = Invoke-RestMethod -Uri http://localhost:4040/api/tunnels
          $address = $response.tunnels.public_url.Replace("tcp://", "")
          
          Write-Host "=========================================="
          Write-Host "ðŸš€ RDP IS READY!"
          Write-Host "ADDRESS  : $address"
          Write-Host "USERNAME : .\${{ secrets.RDP_USERNAME }}"
          Write-Host "PASSWORD : [As set in your GitHub Secrets]"
          Write-Host "=========================================="

      - name: 4. Keep Alive
        run: |
          $i = 0
          while($i -lt 360) {
            Write-Host "Machine is Online... $(Get-Date)"
            Start-Sleep -Seconds 60
            $i++
          }
